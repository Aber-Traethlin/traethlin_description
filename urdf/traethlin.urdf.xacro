<?xml version="1.0"?>

<!-- traethlin.urdf.xacro

This file defines a model of the Traethlin robot.

It is derived from the autorally ROS package available at https://github.com/AutoRally.

Lengths are measured in meters, angles are measured in radians, and masses are
measured in kilograms. All of these values are approximations.

To work with Gazebo, each link must have an inertial element, even if
the link only serves to connect two joints. To be visible in Gazebo, a link
must have a collision element. Furthermore, the link must have a Gazebo
material.
-->
<robot name="traethlin" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:arg name="camera_type" default="oak-d-s2" />
  <!-- Possible values are 'oak-d-s2' or 'd455' -->

  <material name="black">
    <color rgba="0.0 0.0 0.0 1"/>
  </material>
  <material name="chassis_mat">
    <color rgba="0.2 0.2 0.2 1"/>
  </material>
  <material name="lightgrey">
    <color rgba="0.8 0.8 0.8 1"/>
  </material>
  <material name="orange">
    <color rgba="1.0 0.5 0.05 1"/>
  </material>
  <material name="off_white">
    <color rgba="0.9 0.9 0.5 1"/>
  </material>

  <!-- Gazebo colours -->
  <!-- These are to be used inside a <material> tag in a <agzebo> tag. -->
  <xacro:macro name="gazebo_black">
    <ambient>0.0 0.0 0.0 1</ambient>
    <diffuse>0.0 0.0 0.0 1</diffuse>
    <specular>0.0 0.0 0.0 1</specular>
  </xacro:macro>
  <xacro:macro name="gazebo_white">
    <ambient>1.0 1.0 1.0 1</ambient>
    <diffuse>1.0 1.0 1.0 1</diffuse>
    <specular>1.0 1.0 1.0 1</specular>
  </xacro:macro>
  <xacro:macro name="gazebo_grey">
    <ambient>0.3 0.3 0.3 1</ambient>
    <diffuse>0.7 0.7 0.7 1</diffuse>
    <specular>0.01 0.01 0.01 1</specular>
  </xacro:macro>

  <!-- Null inertial element. This is needed to make the model work with
       Gazebo. -->
  <xacro:macro name="null_inertial">
    <inertial>
      <!-- <mass value="8e-3"/>
      <inertia ixx="8e-3" ixy="0" ixz="0" iyy="8e-3" iyz="0" izz="8e-3"/> -->
      <mass value="0.005"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
    </inertial>
  </xacro:macro>


  <!-- Inertia of a cylinder. Height is
       measured along the z axis, which is the cylinder's axis.
       outer_rad is the cylinder's outer radius.
      -->
  <xacro:macro  name="cylinder_inertial"
                params="outer_rad height mass">
    <inertial>
      <mass value="${mass}"/>
      <inertia
        ixx="${(mass*(3*outer_rad*outer_rad+height*height))/12}"
        ixy = "0" ixz = "0"
        iyy="${(mass*(3*outer_rad*outer_rad+height*height))/12}"
        iyz = "0"
        izz="${mass*outer_rad*outer_rad/2}"/>
      <!-- izz above should have the outer_rad squared, but this makes the robot
      explode as soon as it moves. -->
      </inertial>
  </xacro:macro>
  <xacro:macro name="solid_cube_inertial"
               params="x y z mass">
    <inertial>
      <mass value="${mass}"/>
      <inertia ixx="${mass*(y*y+z*z)/12}"
        ixy = "0" ixz = "0"
        iyy="${mass*(x*x+z*z)/12}"
        iyz = "0"
        izz="${mass*(x*x+y*y)/12}"/>
    </inertial>
  </xacro:macro>

  <xacro:include filename="$(find traethlin_description)/urdf/traethlin_constants.xacro" />
  <xacro:include filename="$(find traethlin_description)/urdf/traethlin_shock_absorbers.xacro" />
  <xacro:include filename="$(find traethlin_description)/urdf/traethlin_wheels.xacro" />
  <xacro:include filename="$(find traethlin_description)/urdf/traethlin.gazebo.xacro" />


  <link name="base_link">
  </link>

  <gazebo reference="base_link">
    <material><xacro:gazebo_grey/></material>
  </gazebo>

  <!-- Chassis -->
  <link name="chassis_link">
    <visual>
      <origin xyz="${chassis_length_offset} 0 ${chassis_vertical_offset}"
              rpy="0 0 0"/>

      <geometry>
        <mesh filename="package://traethlin_description/meshes/chassis.stl" scale="0.001 0.001 0.001" />
      </geometry>

      <material name="chassis_mat"/>
    </visual>

    <collision>
      <!--<origin xyz="${-chassis_length/2 + 0.2} 0 ${-chassis_cm_height}"
      rpy="0 0 0"/>-->
      <origin xyz="${chassis_length_offset} 0 ${chassis_vertical_offset}"
              rpy="0 0 0"/>

              <!-- rpy="0 0 0"/> -->

      <geometry>
        <mesh filename="package://traethlin_description/meshes/chassis.stl" scale="0.001 0.001 0.001" />
      </geometry>
    </collision>

    <xacro:solid_cube_inertial
      x="${chassis_length}"
      y="${chassis_width}"
      z="${chassis_height}"
      mass="${chassis_mass}"/>
  </link>
  <gazebo reference="chassis_link">
    <material>
      <ambient>0.175 0.175 0.175 1</ambient>
      <diffuse>0.175 0.175 0.175 1</diffuse>
      <specular>0.175 0.175 0.175 1</specular>
    </material>
    <mu1>0.2</mu1>
    <mu2>0.2</mu2>
  </gazebo>

  <joint name="base_link_to_chasis" type="fixed">
    <origin xyz="0 0 ${chassis_cm_height}" rpy="0 0 0"/>
    <parent link="base_link"/>
    <child link="chassis_link"/>
  </joint>

  <!-- Box of goodies! -->
  <link name="box_of_goodies_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.16 0.16 0.06"/>
      </geometry>
      <material name="lightgrey"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.16 0.16 0.06"/>
      </geometry>
    </collision>
    <xacro:null_inertial/>
  </link>

  <joint name="box_of_goodies_to_chassis_joint" type="fixed">
    <origin xyz="-0.103 0 0.114" rpy="0 0 0"/>
    <parent link="chassis_link"/>
    <child link="box_of_goodies_link"/>
  </joint>

  <link name="imu_link">
    <xacro:null_inertial/>
  </link>

  <joint name="imu_joint" type="fixed">
    <origin xyz="-0.07 0.00 0.09" rpy="0 0 0"/>
    <parent link="chassis_link"/>
    <child link="imu_link"/>
  </joint>


  <link name="gps_link">
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.015" length="0.01"/>
      </geometry>
    </collision>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.015" length="0.01"/>
      </geometry>
      <material name="black"/>
    </visual>

    <xacro:null_inertial/>
  </link>

  <joint name="gps_joint" type="fixed">
    <origin xyz="-0.108 0.0 0.15" rpy="0 0 0"/>
    <parent link="chassis_link"/>
    <child link="gps_link"/>
  </joint>

  <link name="cam_mount_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://traethlin_description/meshes/camera_assembly.stl" scale="0.001 0.001 0.001" />
      </geometry>
      <material name="orange"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://traethlin_description/meshes/camera_assembly.stl" scale="0.001 0.001 0.001" />
      </geometry>
    </collision>
    <xacro:null_inertial/>
  </link>

  <gazebo reference="cam_mount_link">
    <material>
      <ambient>1.0 0.5 0.005 1</ambient>
      <diffuse>1.0 0.5 0.005 1</diffuse>
      <specular>1.0 0.5 0.005 1</specular>
    </material>
  </gazebo>

  <joint name="cam_mount_joint" type="fixed">
    <origin xyz="-0.206 0 0.037" rpy="0 0 0"/>
    <parent link="chassis_link"/>
    <child link="cam_mount_link"/>
  </joint>

  <xacro:property name="cmp_camera_type" value="$(arg camera_type)"/>

  <!-- realsense d455 camera -->
  <xacro:if value="${cmp_camera_type == 'd455'}">
    <link name="camera_base">
      <xacro:null_inertial/>
    </link>
    <xacro:arg name="use_nominal_extrinsics" default="true"/>
    <xacro:include
      filename="$(find realsense2_description)/urdf/_d455.urdf.xacro" />

    <xacro:sensor_d455 parent="camera_base"
                       use_nominal_extrinsics="$(arg use_nominal_extrinsics)">
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </xacro:sensor_d455>

    <joint name="camera_base_joint" type="fixed">
      <origin xyz="0.05 0 0.39" rpy="0 0.38 0"/>
      <parent link="cam_mount_link"/>
      <child link="camera_base"/>
    </joint>
  </xacro:if>

  <!-- oak-d camera -->
  <xacro:if value="${cmp_camera_type == 'oak-d-s2'}">
    <xacro:arg name="camera_name"   default="oak" />
    <xacro:arg name="camera_model"  default="OAK-D-S2" />
    <!--    <xacro:arg name="base_frame"    default="oak-d_frame" />-->
    <xacro:arg name="parent_frame"  default="camera_base" />
    <xacro:arg name="cam_pos_x"     default="0.0" />
    <xacro:arg name="cam_pos_y"     default="0.0" />
    <xacro:arg name="cam_pos_z"     default="0.0" />
    <xacro:arg name="cam_roll"      default="0.0" />
    <xacro:arg name="cam_pitch"     default="0.0" />
    <xacro:arg name="cam_yaw"       default="0.0" />
    <xacro:include
        filename="$(find depthai_descriptions)/urdf/depthai_descr.urdf.xacro"/>

    <joint name="camera_base_joint" type="fixed">
      <origin xyz="0.053 0 0.372" rpy="0 0.38 0"/>
      <parent link="cam_mount_link"/>
      <child link="camera_base"/>
    </joint>
  </xacro:if>


  <joint name="thermal_joint" type="fixed">
    <origin xyz="0.18 0 0.06" rpy="0 0.1 0"/>
    <parent link="chassis_link"/>
    <child link="thermal_link"/>
  </joint>

  <!-- Thermal Camera -->
  <link name="thermal_link">
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.01 0.04 0.04"/>
      </geometry>
    </collision>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.01 0.04 0.04"/>
      </geometry>
      <material name="off_white"/>
    </visual>
    <xacro:null_inertial/>
  </link>

  <!-- Wheels -->
  <xacro:front_wheel lr_prefix="left" fr_prefix="front"
                     lr_reflect="1" fr_reflect="1"
                     tyre_width="${front_tyre_width}"
                     wheel_mass="${front_wheel_mass}"
                     axle_eff_limit="${front_axle_eff_limit}"/>
  <xacro:front_wheel lr_prefix="right" fr_prefix="front"
                     lr_reflect="-1" fr_reflect="1"
                     tyre_width="${front_tyre_width}"
                     wheel_mass="${front_wheel_mass}"
                     axle_eff_limit="${front_axle_eff_limit}"/>
  <xacro:rear_wheel lr_prefix="left" fr_prefix="rear"
                    lr_reflect="1" fr_reflect="-1"
                    tyre_width="${rear_tyre_width}"
                    wheel_mass="${rear_wheel_mass}"
                    axle_eff_limit="${rear_axle_eff_limit}"/>
  <xacro:rear_wheel lr_prefix="right" fr_prefix="rear"
                    lr_reflect="-1" fr_reflect="-1"
                    tyre_width="${rear_tyre_width}"
                    wheel_mass="${rear_wheel_mass}"
                    axle_eff_limit="${rear_axle_eff_limit}"/>

  <gazebo>

    <plugin
      filename="gz-sim-ackermann-steering-system"
      name="gz::sim::systems::AckermannSteering">
      <left_joint>left_front_axle</left_joint>
      <left_joint>left_rear_axle</left_joint>
      <right_joint>right_front_axle</right_joint>
      <right_joint>right_rear_axle</right_joint>
      <left_steering_joint>left_steering_joint</left_steering_joint>
      <right_steering_joint>right_steering_joint</right_steering_joint>
      <kingpin_width>${hex_hub_dist}</kingpin_width>
      <steering_limit>0.7</steering_limit>
      <wheel_base>${wheelbase_front+wheelbase_rear}</wheel_base>
      <wheel_separation>${hex_hub_dist}</wheel_separation>
      <wheel_radius>${tyre_dia/2.0}</wheel_radius>
      <min_velocity>-1</min_velocity>
      <max_velocity>1.5</max_velocity>
      <min_acceleration>-3</min_acceleration>
      <max_acceleration>3</max_acceleration>

      <odom_topic>odom</odom_topic>
      <tf_topic>/tf</tf_topic>
      <frame_id>odom</frame_id>
      <child_frame_id>base_link</child_frame_id>
    </plugin>

    <plugin
      filename="gz-sim-joint-state-publisher-system"
      name="gz::sim::systems::JointStatePublisher">
      <topic>joint_states</topic>
    </plugin>
  </gazebo>
</robot>
